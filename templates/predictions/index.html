{% extends 'base.html' %}
{% load static %}

{% block page_styles %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
  <link rel="stylesheet" href="{% static 'css/index.css' %}">
  {# ‚ñº‚ñº‚ñº Style untuk AI explanation ‚ñº‚ñº‚ñº #}
  <style>
      #ai-explanation-container {
          margin-top: 25px;
          padding-top: 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      #ai-explanation {
          font-size: 0.95rem;
          color: var(--muted); /* Warna abu-abu */
          line-height: 1.6;
          font-style: italic; /* Miring */
          background-color: rgba(0,0,0,0.1); /* Latar sedikit beda */
          padding: 12px 15px;
          border-radius: 6px;
          border-left: 3px solid var(--accent); /* Aksen di kiri */
      }
      #ai-explanation::before {
          content: "ü§ñ Analisis AI: "; /* Tambah label */
          font-style: normal; /* Label tidak miring */
          font-weight: 600; /* Label tebal */
          color: #cbd5e1; /* Warna label lebih terang */
      }

      /* === SPINNER LOADING ANIMASI ELEGAN === */
#loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    text-align: center;
    padding: 25px 0;
}

.spinner {
    width: 42px;
    height: 42px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: var(--accent, #06b6d4);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

#loading-spinner p {
    color: #e5e7eb;
    font-size: 0.95rem;
    letter-spacing: 0.4px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Agar efek muncul halus */
.hidden {
    display: none !important;
    opacity: 0;
    transition: opacity 0.3s ease;
}
  </style>
  {# ‚ñ≤‚ñ≤‚ñ≤ Akhir Style AI ‚ñ≤‚ñ≤‚ñ≤ #}
{% endblock %}


{% block content %}

<div class="container">
    
    {% csrf_token %}

    <h1>Prediksi Pertandingan Sepak Bola</h1>

    <div class="note">
        ‚ö†Ô∏è Catatan: Prediksi otomatis saat ini mendukung 5 liga utama (Serie A, La Liga, Premier League, Bundesliga, Ligue 1). 
        Untuk liga lainnya, silakan masukkan data Elo tim secara manual atau biarkan default.
    </div>

    <div class="form-group">
        <label for="League">Liga</label>
        <select id="League" class="input-field">
            <option value="">Pilih liga...</option>
        </select>
    </div>

    <div class="form-group">
        <label for="HomeTeam">Home</label>
        <select id="HomeTeam" class="input-field" disabled>
            <option value="">Pilih tim kandang...</option>
        </select>
    </div>

    <div class="form-group">
        <label for="AwayTeam">Away</label>
        <select id="AwayTeam" class="input-field" disabled>
            <option value="">Pilih tim tandang...</option>
        </select>
    </div>

    <div id="loading-spinner" class="hidden" style="text-align: center; margin: 20px 0;">
        <p>Loading...</p> 
    </div>

    <div id="feature-section" class="hidden">
        <h2>üìä Fitur Pertandingan</h2>
        <div class="note-elo" style="margin-bottom:10px; font-size:0.9rem; color:#f39c12;">
            ‚ö†Ô∏è ELO digunakan untuk menilai kekuatan tim. Untuk liga yang sudah tersedia (5 liga utama), ELO dihitung otomatis. Untuk liga lain, Anda bisa memasukkan nilai ELO sendiri (default 1500).
        </div>
        <div class="elo-section">
            <div class="grid">
                <div class="input-wrapper">
                    <label for="HomeTeamElo">Elo Home</label>
                    <input id="HomeTeamElo" class="auto-input" placeholder="Elo tim kandang">
                </div>
                <div class="input-wrapper">
                    <label for="AwayTeamElo">Elo Away</label>
                    <input id="AwayTeamElo" class="auto-input" placeholder="Elo tim tandang">
                </div>
            </div>
            <div class="input-wrapper" style="max-width:350px;margin:18px auto 0 auto;">
                <label for="EloDifference">Selisih Elo</label>
                <input id="EloDifference" class="auto-input" placeholder="EloDifference">
            </div>
        </div>

        <div class="stats-section">
            <div class="grid stats-grid">
                <div>
                    <h3 class="stats-title">Statistik Tim Home</h3>
                    <div class="input-wrapper"><label for="Home_AvgGoalsScored">Gol Dicetak</label><input id="Home_AvgGoalsScored" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Home_AvgGoalsConceded">Gol Kebobolan</label><input id="Home_AvgGoalsConceded" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Home_Wins">Menang</label><input id="Home_Wins" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Home_Draws">Seri</label><input id="Home_Draws" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Home_Losses">Kalah</label><input id="Home_Losses" class="auto-input"></div>
                </div>
                <div>
                    <h3 class="stats-title">Statistik Tim Away</h3>
                    <div class="input-wrapper"><label for="Away_AvgGoalsScored">Gol Dicetak</label><input id="Away_AvgGoalsScored" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Away_AvgGoalsConceded">Gol Kebobolan</label><input id="Away_AvgGoalsConceded" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Away_Wins">Menang</label><input id="Away_Wins" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Away_Draws">Seri</label><input id="Away_Draws" class="auto-input"></div>
                    <div class="input-wrapper"><label for="Away_Losses">Kalah</label><input id="Away_Losses" class="auto-input"></div>
                </div>
            </div>
        </div>

        <div class="hth-section">
            <h3 class="stats-title">Statistik H2H</h3>
            <div class="grid hth-grid">
                <div class="input-wrapper"><label for="HTH_HomeWins">Home Menang</label><input id="HTH_HomeWins" class="auto-input"></div>
                <div class="input-wrapper"><label for="HTH_AwayWins">Away Menang</label><input id="HTH_AwayWins" class="auto-input"></div>
                <div class="input-wrapper"><label for="HTH_Draws">Seri</label><input id="HTH_Draws" class="auto-input"></div>
                <div class="input-wrapper"><label for="HTH_AvgHomeGoals">Gol Home</label><input id="HTH_AvgHomeGoals" class="auto-input"></div>
                <div class="input-wrapper"><label for="HTH_AvgAwayGoals">Gol Away</label><input id="HTH_AvgAwayGoals" class="auto-input"></div>
            </div>
        </div>

        <h3 class="odds-title">üí∞ Odds</h3>
        <div class="odds-group">
            <div class="input-wrapper"><label for="AvgH">Odds Home</label><input id="AvgH" class="auto-input"></div>
            <div class="input-wrapper"><label for="AvgD">Odds Draw</label><input id="AvgD" class="auto-input"></div>
            <div class="input-wrapper"><label for="AvgA">Odds Away</label><input id="AvgA" class="auto-input"></div>
            <div class="input-wrapper"><label for="AvgOver25">Odds Over 2.5</label><input id="AvgOver25" class="auto-input"></div>
            <div class="input-wrapper"><label for="AvgUnder25">Odds Under 2.5</label><input id="AvgUnder25" class="auto-input"></div>
        </div>

        <button id="PredictBtn" class="btn">Prediksi Sekarang</button>
    </div>

    <div id="result" class="hidden">
        {# ‚ñº‚ñº‚ñº TAMBAHKAN KONTENER & ELEMEN PENJELASAN AI ‚ñº‚ñº‚ñº #}
       <div id="prediction-content">
           </div>
       <div id="ai-explanation-container" class="hidden"> {# Awalnya disembunyikan #}
           <div id="ai-explanation">Memuat penjelasan AI...</div>
       </div>
    </div>
</div> 

<footer class="main-footer">
    <div class="footer-copyright">&copy; 2025 Prediksi-Kan. All rights reserved.</div>
    <div class="footer-data-source">Data sourced from <a href="https://www.football-data.co.uk/" target="_blank" rel="noopener noreferrer">football-data.co.uk</a></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // --- Definisikan semua elemen HTML di awal ---
    const leagueEl = document.getElementById('League');
    const homeEl = document.getElementById('HomeTeam');
    const awayEl = document.getElementById('AwayTeam');
    const featureSection = document.getElementById('feature-section');
    const predictBtn = document.getElementById('PredictBtn');
    const resultEl = document.getElementById('result');
    const loadingSpinner = document.getElementById('loading-spinner');
    
    // ‚ñº‚ñº‚ñº TAMBAHKAN DEKLARASI INI ‚ñº‚ñº‚ñº
    const predictionContentEl = document.getElementById('prediction-content'); 
    const aiExplanationContainer = document.getElementById('ai-explanation-container'); 
    const aiExplanationEl = document.getElementById('ai-explanation'); 
    // ‚ñ≤‚ñ≤‚ñ≤ AKHIR TAMBAHAN ‚ñ≤‚ñ≤‚ñ≤

    let currentFeatures = null;

    // Inisialisasi Choices.js
    const leagueChoice = new Choices(leagueEl, {
        searchEnabled: false,
        itemSelectText: 'Tekan untuk memilih',
        shouldSort: false, 
        allowHTML: false,
        appendLocation: 'origin',
    });

    const homeChoice = new Choices(homeEl, {
        searchEnabled: true,
        itemSelectText: 'Tekan untuk memilih',
        shouldSort: true, 
        allowHTML: false,
        appendLocation: 'origin',
        searchPlaceholderValue: 'Ketik untuk mencari tim...'
    });

    const awayChoice = new Choices(awayEl, {
        searchEnabled: true,
        itemSelectText: 'Tekan untuk memilih',
        shouldSort: true, 
        allowHTML: false,
        appendLocation: 'origin',
        searchPlaceholderValue: 'Ketik untuk mencari tim...'
    });
    
    // ===================== LOAD LEAGUES =====================
    async function loadLeagues() {
        try {
            const res = await fetch('/api/leagues');
            const j = await res.json();
            const choices = []; 

            if (j.status === 'ok' && Array.isArray(j.leagues)) {
                j.leagues.forEach(l => {
                    choices.push({ value: l, label: l });
                });
                leagueChoice.setChoices(choices, 'value', 'label', true);
                leagueChoice.setValue(['']); 
            } else {
                 leagueChoice.setChoices([
                     { value: '', label: '(Gagal memuat liga)' }
                 ], 'value', 'label', true);
                 leagueChoice.setValue(['']);
            }
        } catch {
            leagueChoice.setChoices([
                { value: '', label: '(Error koneksi)', disabled: true }
            ], 'value', 'label', true);
            leagueChoice.setValue(['']); 
        }
    }

    // ===================== LOAD TEAMS =====================
    async function loadTeamsForLeague(league) {
        try {
            const res = await fetch(`/api/teams?league=${encodeURIComponent(league)}`);
            const j = await res.json();
            const teamChoices = [];

            if (j.status === 'ok' && Array.isArray(j.teams)) {
                j.teams.forEach(t => {
                    teamChoices.push({ value: t, label: t });
                });
                homeChoice.setChoices(teamChoices, 'value', 'label', true);
                awayChoice.setChoices(teamChoices, 'value', 'label', true);
                homeChoice.setValue(['']);
                awayChoice.setValue(['']);
                homeChoice.enable();
                awayChoice.enable();
            } else {
                 homeChoice.disable();
                 awayChoice.disable();
                 homeChoice.clearStore();
                 awayChoice.clearStore();
                 homeChoice.setValue(['']); 
                 awayChoice.setValue(['']);
            }
        } catch {
            alert('Gagal memuat tim (catch block)');
            homeChoice.disable();
            awayChoice.disable();
            homeChoice.clearStore();
            awayChoice.clearStore();
            homeChoice.setValue(['']);
            awayChoice.setValue(['']);
        }
    }

    // ===================== FETCH FEATURES =====================
    async function fetchAndStoreFeatures(league, home, away) {
        const res = await fetch('/api/features', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ league, home, away })
        });

        const j = await res.json();
        if (j.status === 'ok') {
            currentFeatures = j.features;
            fillFeatureInputsWithTotals(j.features);
        } else {
            throw new Error(j.message || 'Fitur gagal dimuat');
        }
    }

    // ===================== TAMPILKAN FITUR DI INPUT =====================
    function fillFeatureInputsWithTotals(features) {
        const displayData = { ...features };
        const home_matches = features.Home_Wins + features.Home_Draws + features.Home_Losses;
        const away_matches = features.Away_Wins + features.Away_Draws + features.Away_Losses;
        const hth_matches = features.HTH_HomeWins + features.HTH_AwayWins + features.HTH_Draws;
        const home_count = home_matches > 0 ? home_matches : 5;
        const away_count = away_matches > 0 ? away_matches : 5;
        const hth_count = hth_matches > 0 ? hth_matches : 5;

        displayData.Home_AvgGoalsScored = Math.round(features.Home_AvgGoalsScored * home_count);
        displayData.Home_AvgGoalsConceded = Math.round(features.Home_AvgGoalsConceded * home_count);
        displayData.Away_AvgGoalsScored = Math.round(features.Away_AvgGoalsScored * away_count);
        displayData.Away_AvgGoalsConceded = Math.round(features.Away_AvgGoalsConceded * away_count);
        displayData.HTH_AvgHomeGoals = Math.round(features.HTH_AvgHomeGoals * hth_count);
        displayData.HTH_AvgAwayGoals = Math.round(features.HTH_AvgAwayGoals * hth_count);

        const featureIdMap = { 'Avg>2.5': 'AvgOver25', 'Avg<2.5': 'AvgUnder25' };
        for (const [key, val] of Object.entries(displayData)) {
            const elementId = featureIdMap[key] || key;
            const el = document.getElementById(elementId);
            if (el) {
                if (key === 'EloDifference' && typeof val === 'number') {
                    el.value = val.toFixed(2);
                } else {
                    el.value = val;
                }
            }
        }

        ['AvgH', 'AvgD', 'AvgA', 'AvgOver25', 'AvgUnder25'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });

        featureSection.classList.remove('hidden');
    }

    // ===================== AMBIL INPUT UNTUK PREDIKSI =====================
    function getFeaturesForPrediction() {
        if (!currentFeatures) {
            throw new Error('Fitur pertandingan belum dimuat. Silakan pilih tim terlebih dahulu.');
        }
        const featuresForPrediction = { ...currentFeatures };
        featuresForPrediction.AvgH = parseFloat(document.getElementById('AvgH').value) || 0;
        featuresForPrediction.AvgD = parseFloat(document.getElementById('AvgD').value) || 0;
        featuresForPrediction.AvgA = parseFloat(document.getElementById('AvgA').value) || 0;
        featuresForPrediction['Avg>2.5'] = parseFloat(document.getElementById('AvgOver25').value) || 0;
        featuresForPrediction['Avg<2.5'] = parseFloat(document.getElementById('AvgUnder25').value) || 0;
        return featuresForPrediction;
    }

    // ===================== TAMPILKAN HASIL =====================
    function showPredictionResult(json) {
        if (predictionContentEl) predictionContentEl.innerHTML = ''; 
        if (aiExplanationContainer) aiExplanationContainer.classList.add('hidden'); 
        if (aiExplanationEl) aiExplanationEl.textContent = 'Memuat penjelasan AI...'; 

        if (resultEl) resultEl.classList.remove('hidden'); 

        if (!json || json.status !== 'ok' || !json.prediction) {
             if (predictionContentEl) predictionContentEl.innerHTML = `<div style="color: red; text-align: center;">‚ùå Gagal menampilkan hasil prediksi: ${json.message || 'Error tidak diketahui'}</div>`;
            return; 
        }

        const p = json.prediction;
        const mainResultHTML = `
            <div class="result-title">üìä Hasil Prediksi</div>
            <div id="main-result" style="text-align:center; margin-bottom: 20px;">
              üè† (H/D/A): <b>${p.HDA?.label || '-'}</b><br>
              ‚öΩ (O/U 2.5): <b>${p.OU25?.label || '-'}</b><br>
              ü§ù (BTTS): <b>${p.BTTS?.label || '-'}</b>
            </div>
            <div id="prob-bars" class="prob-section">
              ${renderProbBlock('üè† (Home / Draw / Away)', p.HDA?.probs)}
              ${renderProbBlock('‚öΩ Over / Under 2.5', p.OU25?.probs)}
              ${renderProbBlock('ü§ù Both Team To Score', p.BTTS?.probs)}
            </div>
        `;
        
        if (predictionContentEl) predictionContentEl.innerHTML = mainResultHTML; 
        animateBars(); 

        // Tampilkan Penjelasan AI 
        if (json.explanation && aiExplanationEl && aiExplanationContainer) {
            aiExplanationEl.textContent = json.explanation; 
            aiExplanationContainer.classList.remove('hidden'); 
        } else if(aiExplanationEl && aiExplanationContainer) {
             aiExplanationEl.textContent = 'Penjelasan AI tidak tersedia.'; 
             aiExplanationContainer.classList.remove('hidden'); 
        }
    }
    
    function getGradientColor(percent) {
        let r, g, b = 0;
        if (percent < 50) {
            r = 255;
            g = Math.round(5.1 * percent);
        } else {
            g = 255;
            r = Math.round(510 - 5.1 * percent);
        }
        return `linear-gradient(90deg, rgb(${r},${g},0) 0%, rgb(${r},${g},0) ${percent}%)`;
    }
    
    function renderProbBlock(title, probs) {
        if (!probs) return '';
        let html = `<div class="prob-group"><h4>${title}</h4>`;
        for (const [label, val] of Object.entries(probs)) {
            const percent = (val * 100).toFixed(1);
            const gradient = getGradientColor(percent);
            html += `
            <div class="prob-item">
                <span>${label}</span>
                <div class="prob-bar"><div class="bar" style="width:${percent}%; background:${gradient}"></div></div>
                <span>${percent}%</span>
            </div>`;
        }
        html += `</div>`;
        return html;
    }

    function animateBars() {
        document.querySelectorAll('.bar').forEach(bar => {
            const percent = bar.style.width.replace('%', '');
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.transition = 'width 1s ease';
                bar.style.width = `${percent}%`;
            }, 50);
        });
    }

    // ===================== EVENT LISTENERS =====================
    leagueEl.addEventListener('change', e => {
        const league = e.target.value;
        if (!league) return;
        homeChoice.disable();
        awayChoice.disable();
        homeChoice.clearStore();
        awayChoice.clearStore();
        homeChoice.setValue(['']);
        awayChoice.setValue(['']);
        loadTeamsForLeague(league);
        featureSection.classList.add('hidden');
        resultEl.classList.add('hidden');
        currentFeatures = null;
    });

    [homeEl, awayEl].forEach(sel => {
        const choiceInstance = (sel.id === 'HomeTeam') ? homeChoice : awayChoice;
        choiceInstance.passedElement.element.addEventListener('choice', async (event) => {
            featureSection.classList.add('hidden');
            resultEl.classList.add('hidden');
            currentFeatures = null; 
            const leagueValue = leagueChoice.getValue(true);
            const homeValue = homeChoice.getValue(true);
            const awayValue = awayChoice.getValue(true);
            
            if (leagueValue && leagueValue !== '' &&
                homeValue && homeValue !== '' &&
                awayValue && awayValue !== '' &&
                homeValue !== awayValue) {
                try {
                    if (loadingSpinner) loadingSpinner.classList.remove('hidden');
                    await fetchAndStoreFeatures(leagueValue, homeValue, awayValue);
                } catch (err) {
                    console.error('Error fetching features:', err);
                    alert('Gagal memuat fitur otomatis: ' + err.message);
                    featureSection.classList.add('hidden');
                } finally {
                     if (loadingSpinner) loadingSpinner.classList.add('hidden');
                }
            }
        });

        sel.addEventListener('change', () => {
            const homeVal = homeChoice.getValue(true);
            const awayVal = awayChoice.getValue(true);
            if (!homeVal || homeVal === '' || !awayVal || awayVal === '') {
                 featureSection.classList.add('hidden');
                 resultEl.classList.add('hidden');
                 currentFeatures = null;
            }
        });
    });

    // ===================== PREDICT BUTTON =====================
    predictBtn.addEventListener('click', async () => {
        console.log('Tombol Prediksi diklik');

        // Simpan teks asli tombol
        const originalText = predictBtn.innerHTML;
        predictBtn.disabled = true;
        predictBtn.innerHTML = 'Memproses...';

        resultEl.classList.add('hidden');
        if (predictionContentEl) predictionContentEl.innerHTML = '';

        try {
            const features = getFeaturesForPrediction();
            const res = await fetch('/api/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    league: leagueChoice.getValue(true),
                    features,
                    home_team: homeChoice.getValue(true),
                    away_team: awayChoice.getValue(true)
                })
            });

            const json = await res.json();
            showPredictionResult(json);
        } catch (err) {
            console.error('Error prediksi:', err);
            alert('Terjadi kesalahan saat prediksi: ' + err.message);
        } finally {
            predictBtn.disabled = false;
            predictBtn.innerHTML = originalText;
            console.log('Prediksi selesai, tombol dikembalikan.');
        }
    });

    loadLeagues();
});
</script>

{% endblock %}