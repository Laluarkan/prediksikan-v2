{% extends 'base.html' %}
{% load static %}
{% load dict_filters %}
{% load tz %}

{% block title %}History | Prediksi-kan{% endblock %}

{% block page_styles %}
  <link rel="stylesheet" href="{% static 'css/history.css' %}">
{% endblock %}

{% block content %}
<div class="history-container">
  <h1>Riwayat Prediksi Anda ({{ latest_histories|length }}/20 Terbaru)</h1>

  {% if latest_histories %}
    <div class="history-grid">
      {% for item in latest_histories %}
        <a href="{% url 'history_detail' item.id %}"
           class="hist-item-link {% if selected_history and selected_history.id == item.id %}selected{% endif %}">
          <strong>{{ item.league }}</strong>
          <span class="hist-match">{{ item.home_team }} vs {{ item.away_team }}</span>
          
          <small>{{ item.timestamp|timezone:"Asia/Makassar"|date:"d-m-Y H:i" }} WITA</small>
          
          <span class="hist-preds">
            Model: {{ item.prediction_data.HDA.label|default:'-' }} |
            OU: {{ item.prediction_data.OU25.label|default:'-' }} |
            BTTS: {{ item.prediction_data.BTTS.label|default:'-' }}
          </span>
          
          {% if item.is_preferred_choice %}
            {% if item.hda_chosen != 'N' or item.over_under_chosen != 'N' or item.btts_chosen != 'N' %}
              <span class="hist-user-choice">
                ‚≠ê Pilihan Anda: 
                {% if item.hda_chosen != 'N' %}{{ item.hda_chosen }} {% endif %}
                {% if item.over_under_chosen != 'N' %}| {{ item.over_under_chosen }} {% endif %}
                {% if item.btts_chosen != 'N' %}| {{ item.btts_chosen }}{% endif %}
              </span>
            {% endif %}
          {% endif %}
          </a>
      {% endfor %}
    </div>
  {% else %}
    <p style="text-align: center;">Anda belum memiliki riwayat prediksi.</p>
  {% endif %}

  {% if selected_history %}
     <hr style="border-color: rgba(255,255,255,0.1); margin: 40px 0;">
  {% endif %}

  {% if selected_history %}
    <div class="prediction-details">
      <h2>Detail Prediksi: {{ selected_history.home_team }} vs {{ selected_history.away_team }}</h2>
      
      <p style="text-align:center; margin-top:-20px; margin-bottom:30px; color:var(--muted);">
          Prediksi pada: {{ selected_history.timestamp|timezone:"Asia/Makassar"|date:"d F Y H:i" }} WITA
      </p>

      {% if selected_history.is_preferred_choice %}
        {% if selected_history.hda_chosen != 'N' or selected_history.over_under_chosen != 'N' or selected_history.btts_chosen != 'N' %}
          <div class="user-choices-detail">
              <h3>‚≠ê Pilihan Terbaik Anda</h3>
              <p>
                  {% if selected_history.hda_chosen != 'N' %}
                      <span>H/D/A: <strong>{{ selected_history.hda_chosen }}</strong></span>
                  {% endif %}
                  {% if selected_history.over_under_chosen != 'N' %}
                      <span>O/U 2.5: <strong>{{ selected_history.over_under_chosen }}</strong></span>
                  {% endif %}
                  {% if selected_history.btts_chosen != 'N' %}
                      <span>BTTS: <strong>{{ selected_history.btts_chosen }}</strong></span>
                  {% endif %}
              </p>
          </div>
        {% endif %}
      {% endif %}
      
      {% with features=selected_history.input_features %}
        {% if features %}
          {# Bagian ELO (tidak berubah) #}
          <h3>üìà Elo Rating</h3>
          <div class="elo-section">
              <div class="grid">
                  {% for key in feature_columns_meta.elo %}
                      {% if key != 'EloDifference' %}
                           <div class="input-wrapper">
                               <label for="hist_{{ key }}">{{ feature_labels|get_item:key|default:key }}</label>
                               <input id="hist_{{ key }}" class="auto-input" value="{{ features|get_item:key|floatformat:2|default:'' }}" readonly>
                           </div>
                      {% endif %}
                  {% endfor %}
              </div>
              {% if 'EloDifference' in features %}
                   <div class="input-wrapper" style="max-width:350px; margin:18px auto 0 auto;">
                       <label for="hist_EloDifference">{{ feature_labels|get_item:'EloDifference'|default:'EloDifference' }}</label>
                       <input id="hist_EloDifference" class="auto-input" value="{{ features|get_item:'EloDifference'|floatformat:2|default:'' }}" readonly>
                   </div>
               {% endif %}
          </div>

          {# ‚ñº‚ñº‚ñº BAGIAN STATISTIK HOME & AWAY (GUNAKAN FILTER MULTIPLY) ‚ñº‚ñº‚ñº #}
           <h3>üìä Statistik Tim (Saat Prediksi)</h3>
           <div class="stats-section">
               <div class="grid stats-grid">
                   <div>
                       <h4 class="stats-title">Statistik Tim Home</h4>
                       {# Ambil jumlah match Home #}
                       {% with home_wins=features|get_item:'Home_Wins'|default:0 home_draws=features|get_item:'Home_Draws'|default:0 home_losses=features|get_item:'Home_Losses'|default:0 %}
                       {% with home_count_calc=home_wins|add:home_draws|add:home_losses %}
                           {# Fallback ke 5 jika count 0 tapi avg tidak 0 #}
                           {% with home_count=home_count_calc|default_if_none:5 %}
                               {% for key in feature_columns_meta.home_stats %}
                                   <div class="input-wrapper">
                                       <label for="hist_{{ key }}">{{ feature_labels|get_item:key|default:key }}</label>
                                       {# Logika untuk menampilkan total gol atau nilai asli #}
                                       {% if 'AvgGoals' in key %}
                                           {% with avg_goals=features|get_item:key|default:0 %}
                                               {# Hitung total: avg * count menggunakan filter multiply #}
                                               <input id="hist_{{ key }}" class="auto-input" value="{{ avg_goals|multiply:home_count|floatformat:0 }}" readonly>
                                           {% endwith %}
                                       {% else %}
                                           {# Tampilkan nilai W/D/L seperti biasa #}
                                           <input id="hist_{{ key }}" class="auto-input" value="{{ features|get_item:key|floatformat:0|default:'0' }}" readonly>
                                       {% endif %}
                                   </div>
                               {% endfor %}
                           {% endwith %}
                       {% endwith %}
                       {% endwith %}
                   </div>
                   <div>
                       <h4 class="stats-title">Statistik Tim Away</h4>
                       {# Ambil jumlah match Away #}
                       {% with away_wins=features|get_item:'Away_Wins'|default:0 away_draws=features|get_item:'Away_Draws'|default:0 away_losses=features|get_item:'Away_Losses'|default:0 %}
                       {% with away_count_calc=away_wins|add:away_draws|add:away_losses %}
                           {# Fallback ke 5 jika count 0 tapi avg tidak 0 #}
                           {% with away_count=away_count_calc|default_if_none:5 %}
                               {% for key in feature_columns_meta.away_stats %}
                                   <div class="input-wrapper">
                                       <label for="hist_{{ key }}">{{ feature_labels|get_item:key|default:key }}</label>
                                       {# Logika untuk menampilkan total gol atau nilai asli #}
                                       {% if 'AvgGoals' in key %}
                                           {% with avg_goals=features|get_item:key|default:0 %}
                                               {# Hitung total: avg * count menggunakan filter multiply #}
                                               <input id="hist_{{ key }}" class="auto-input" value="{{ avg_goals|multiply:away_count|floatformat:0 }}" readonly>
                                           {% endwith %}
                                       {% else %}
                                           {# Tampilkan nilai W/D/L seperti biasa #}
                                           <input id="hist_{{ key }}" class="auto-input" value="{{ features|get_item:key|floatformat:0|default:'0' }}" readonly>
                                       {% endif %}
                                   </div>
                               {% endfor %}
                           {% endwith %}
                       {% endwith %}
                       {% endwith %}
                   </div>
               </div>
           </div>
           {# ‚ñ≤‚ñ≤‚ñ≤ AKHIR PERUBAHAN STATISTIK ‚ñ≤‚ñ≤‚ñ≤ #}


          {# ‚ñº‚ñº‚ñº BAGIAN HTH (GUNAKAN FILTER MULTIPLY) ‚ñº‚ñº‚ñº #}
          <h3>ü§ù Statistik H2H (Saat Prediksi)</h3>
          <div class="hth-section">
              {# Ambil jumlah match HTH #}
              {% with hth_home_wins=features|get_item:'HTH_HomeWins'|default:0 hth_away_wins=features|get_item:'HTH_AwayWins'|default:0 hth_draws=features|get_item:'HTH_Draws'|default:0 %}
              {% with hth_count_calc=hth_home_wins|add:hth_away_wins|add:hth_draws %}
                  {# Fallback ke 5 jika count 0 tapi avg tidak 0 #}
                  {% with hth_count=hth_count_calc|default_if_none:5 %}
                      <div class="grid hth-grid">
                         {% for key in feature_columns_meta.hth %}
                            <div class="input-wrapper">
                                <label for="hist_{{ key }}">{{ feature_labels|get_item:key|default:key }}</label>
                                {# Logika untuk menampilkan total gol atau nilai asli #}
                                {% if 'AvgGoals' in key %}
                                    {% with avg_goals=features|get_item:key|default:0 %}
                                        {# Hitung total: avg * count menggunakan filter multiply #}
                                        <input id="hist_{{ key }}" class="auto-input" value="{{ avg_goals|multiply:hth_count|floatformat:0 }}" readonly>
                                    {% endwith %}
                                {% else %}
                                    {# Tampilkan nilai W/D/L seperti biasa #}
                                    <input id="hist_{{ key }}" class="auto-input" value="{{ features|get_item:key|floatformat:0|default:'0' }}" readonly>
                                {% endif %}
                            </div>
                         {% endfor %}
                      </div>
                  {% endwith %}
              {% endwith %}
              {% endwith %}
          </div>
          {# ‚ñ≤‚ñ≤‚ñ≤ AKHIR PERUBAHAN HTH ‚ñ≤‚ñ≤‚ñ≤ #}


          {# Bagian Odds (tidak berubah) #}
          <h3>üí∞ Odds (Saat Prediksi)</h3>
          <div class="odds-group">
             {% for key in feature_columns_meta.odds %}
                <div class="input-wrapper">
                    <label for="hist_{{ key }}">{{ feature_labels|get_item:key|default:key }}</label>
                    <input id="hist_{{ key }}" class="auto-input"
                           value="{{ features|get_item:key|floatformat:2|default:'' }}" readonly>
                </div>
             {% endfor %}
          </div>

        {% else %}
          <p style="text-align: center; color: var(--muted);">Fitur input untuk prediksi ini tidak tersimpan.</p>
        {% endif %}
      {% endwith %} {# Akhir alias features #}

      {# Tampilkan Hasil Prediksi (Bar) #}
      <div id="result-details">
         <p style="text-align: center; color: var(--muted);">Memuat hasil prediksi...</p>
      </div>

    </div>

    {{ selected_history.prediction_data|json_script:"prediction-data-json" }}

<script src="{% static 'js/history.js' %}"></script>

  {% else %}
    {# Pesan jika tidak ada riwayat dipilih (hanya grid atas yang tampil) #}
    <p style="text-align: center; margin-top: 30px;">Klik salah satu riwayat di atas untuk melihat detailnya.</p>
  {% endif %}

</div>
{% endblock %}