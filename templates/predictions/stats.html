{% extends 'base.html' %}
{% load static %}

{% block page_styles %}
  <link rel="stylesheet" href="{% static 'css/stats.css' %}">
{% endblock %}


{% block content %}
<div class="stats-container">
  
  {% csrf_token %}

  <h1>ðŸ“Š Statistik Tim</h1>
  
  <div class="controls">
    <label for="league-select">Liga</label>
    <select id="league-select" class="input-select">
      <option value="">-- Memuat Liga --</option> 
    </select>
    
    <label for="team-select">Tim</label>
    <select id="team-select" class="input-select">
        <option value="">-- Pilih Liga Dulu --</option>
    </select>
    
    <button id="load-stats" class="btn-primary">Tampilkan Statistik</button>
  </div>

  <div id="team-stats" class="team-stats">
    Pilih liga dan tim untuk melihat statistik.
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // === Ambil elemen ===
  const leagueSel = document.getElementById('league-select');
  const teamSel = document.getElementById('team-select');
  const loadBtn = document.getElementById('load-stats');
  const container = document.getElementById('team-stats');
  
  // Ambil token CSRF
  const csrfTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;

  // === 1. Ambil daftar liga ===
  async function loadLeagues() {
    try {
      const res = await fetch('/api/leagues');
      const data = await res.json();
      if (data.status === 'ok') {
        leagueSel.innerHTML = '<option value="">-- Pilih Liga --</option>'; // Placeholder awal
        data.leagues.forEach(l => {
          leagueSel.innerHTML += `<option value="${l}">${l}</option>`;
        });
      } else {
        leagueSel.innerHTML = '<option value="">-- Gagal Memuat --</option>';
      }
    } catch (err) {
        console.error("Error loading leagues:", err);
        leagueSel.innerHTML = '<option value="">-- Error Koneksi --</option>';
    }
  }

  // === 2. Ambil tim saat liga dipilih ===
  leagueSel.addEventListener('change', async () => {
    const league = leagueSel.value;
    teamSel.innerHTML = '<option value="">-- Pilih Tim --</option>'; // Reset tim
    container.innerHTML = 'Pilih liga dan tim untuk melihat statistik.'; // Reset area stats
    
    if (!league) return;

    teamSel.innerHTML = '<option value="">-- Memuat Tim... --</option>'; // Tampilkan loading
    try {
        const res = await fetch(`/api/teams?league=${encodeURIComponent(league)}`);
        const data = await res.json();
        if (data.status === 'ok') {
          teamSel.innerHTML = '<option value="">-- Pilih Tim --</option>'; // Placeholder
          data.teams.forEach(t => {
            teamSel.innerHTML += `<option value="${t}">${t}</option>`;
          });
        } else {
            teamSel.innerHTML = '<option value="">-- Gagal Memuat --</option>';
        }
    } catch (err) {
        console.error("Error loading teams:", err);
        teamSel.innerHTML = '<option value="">-- Error Koneksi --</option>';
    }
  });

  // === 3. Tampilkan statistik tim ===
  loadBtn.addEventListener('click', async () => {
    const league = leagueSel.value;
    const team = teamSel.value;
    if (!league || !team) {
      alert('Pilih liga dan tim terlebih dahulu!');
      return;
    }
    
    if (!csrfToken) {
        alert('Kesalahan: Token keamanan tidak ditemukan. Coba refresh halaman.');
        return;
    }

    container.innerHTML = '<p>Sedang memuat data...</p>'; // Tampilkan loading
    loadBtn.disabled = true; // Nonaktifkan tombol selama loading

    try {
        const res = await fetch('/api/team_stats', {
          method: 'POST',
          headers: { 
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken // Sertakan token CSRF
          },
          body: JSON.stringify({ league, team })
        });
        const data = await res.json();

        if (data.status === 'ok' && data.stats) { // Pastikan data.stats ada
          const s = data.stats;
          // Gunakan toFixed(2) untuk membulatkan rata-rata gol
          const avgScored = s.recent?.AvgGoalsScored ? parseFloat(s.recent.AvgGoalsScored).toFixed(2) : '0.00';
          const avgConceded = s.recent?.AvgGoalsConceded ? parseFloat(s.recent.AvgGoalsConceded).toFixed(2) : '0.00';
          const lastElo = s.last_elo ? parseFloat(s.last_elo).toFixed(2) : '-'; // Bulatkan ELO juga

          container.innerHTML = `
            <h2>Statistik ${team} (${league})</h2> 
            <div class="stats-card">
              <div class="stat-item"><strong>Last Elo</strong><div>${lastElo}</div></div>
              <div class="stat-item"><strong>Avg Goals Scored</strong><div>${avgScored}</div></div>
              <div class="stat-item"><strong>Avg Goals Conceded</strong><div>${avgConceded}</div></div>
              <div class="stat-item"><strong>Wins</strong><div>${s.recent?.Wins || 0}</div></div>
              <div class="stat-item"><strong>Draws</strong><div>${s.recent?.Draws || 0}</div></div>
              <div class="stat-item"><strong>Losses</strong><div>${s.recent?.Losses || 0}</div></div>
            </div>
          `;
        } else {
          container.innerHTML = `<p style="color:red;">Gagal memuat statistik: ${data.message || 'Error tidak diketahui'}</p>`;
        }
    } catch (err) {
        console.error("Error fetching team stats:", err);
        container.innerHTML = `<p style="color:red;">Terjadi kesalahan koneksi saat memuat statistik.</p>`;
    } finally {
        loadBtn.disabled = false; // Aktifkan kembali tombol setelah selesai
    }
  });

  // Muat liga saat halaman pertama kali dibuka
  loadLeagues();
});
</script>

{% endblock %}